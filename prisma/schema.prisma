generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  password     String
  name         String
  created_at   DateTime @default(now())
  last_updated DateTime @updatedAt

  @@map("users")
}

model Menu {
  id       String   @id @default(uuid())
  name     String   @unique
  message  String
  keywords String[]
  active   Boolean  @default(true)

  options MenuOption[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("menus")
}

model MenuOption {
  id      String @id @default(uuid())
  menu_id String
  menu    Menu   @relation(fields: [menu_id], references: [id])

  label   String
  trigger Int
  action  MenuOptionAction

  reply_text  String?
  finish_text String?
  forward_to String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("menu_options")
}

enum WhatsAppInstanceStatus {
  pending
  active
}

enum MenuOptionAction {
  auto_reply
  redirect_queue
  forward
}

model Lead {
  id         String    @id @default(uuid())
  name       String?
  phone      String    @unique
  state      LeadState @default(idle)
  messages   Message[]
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt
}

model Message {
  id         String      @id @default(uuid())
  text       String
  from       MessageFrom
  lead       Lead        @relation(fields: [leadId], references: [id])
  leadId     String
  created_at DateTime    @default(now())
}

enum LeadState {
  idle
  await_option
  await_response
  in_queue
  in_service
}

enum MessageFrom {
  customer
  menu
  agent
}
